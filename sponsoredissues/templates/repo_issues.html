{% extends 'base.html' %}
{% load cents_to_dollars %}

{% block title %}SponsoredIssues - {{ owner }}/{{ repo }} Issues{% endblock %}

{% block head %}
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f8f9fa;
        color: #495057;
        line-height: 1.6;
    }

    .repo-header {
        background: white;
        border-bottom: 1px solid #e9ecef;
        padding: 16px 0;
        margin-bottom: 0;
    }

    .repo-header-content {
        margin: 0 auto;
        padding: 0 20px;
    }

    .repo-title-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .repo-header h1 {
        font-size: 1.75rem;
        color: #1e3a8a;
        font-weight: 700;
        margin: 0px 8px 0px 0px;
    }

    .sponsor-btn {
        background: white;
        color: #ea4aaa;
        border: 1px solid #ea4aaa;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .sponsor-btn:hover {
        background: #ea4aaa;
        color: white;
    }

    .sponsor-stats {
        margin: 12px 0px 0px 0px;
    }

    .sponsor-stat.message {
        font-style: italic;
    }

    .sponsor-stat.message a {
        color: #1e3a8a;
        font-weight: 700;
        text-decoration: none;
    }

    .sponsor-stat.message a:hover {
        text-decoration: underline;
    }

    .sponsor-stat.message .link-btn {
        background: none;
        border: none;
        padding: 0;
        color: #1e3a8a;
        font-weight: 700;
        text-decoration: none;
        cursor: pointer;
        font: inherit;
    }

    .sponsor-stat.message .link-btn:hover {
        text-decoration: underline;
    }

    .sponsor-stat .dollars-value {
        color: #059669;
        font-weight: 700;
    }

    .github_username {
        color: #1e3a8a;
        font-weight: 600;
    }

    .issues-list {
        background: white;
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .issue-item {
        display: flex;
        align-items: center;
        padding: 12px 24px;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s ease;
        gap: 16px;
    }

    .issue-item:last-child {
        border-bottom: none;
    }

    .issue-item:hover {
        background: #f8fafc;
    }

    .rank-section {
        flex-shrink: 0;
        width: 60px;
        text-align: center;
    }

    .rank {
        font-size: 1.2rem;
        font-weight: 700;
        color: #1e3a8a;
    }


    .issue-main {
        flex: 1;
        min-width: 0;
    }

    .issue-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 4px;
        line-height: 1.4;
    }

    .issue-title a {
        color: #1e3a8a;
        text-decoration: none;
    }

    .issue-title a:hover {
        text-decoration: underline;
    }

    .issue-meta {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .labels {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .label {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        border: 1px solid;
    }

    .label-bug {
        background: #fef2f2;
        color: #b91c1c;
        border-color: #fecaca;
    }

    .label-feature {
        background: #eff6ff;
        color: #1d4ed8;
        border-color: #bfdbfe;
    }

    .label-enhancement {
        background: #f0fdf4;
        color: #166534;
        border-color: #bbf7d0;
    }

    .label-priority {
        background: #fffbeb;
        color: #92400e;
        border-color: #fed7aa;
    }

    .label-default {
        background: #f3f4f6;
        color: #374151;
        border-color: #d1d5db;
    }

    .issue-number {
        color: #6b7280;
        font-size: 0.875rem;
    }

    .donation-section {
        flex-shrink: 0;
        text-align: right;
        min-width: 120px;
    }

    .donation-amount {
        font-size: 1.1rem;
        font-weight: 700;
        color: #059669;
    }

    .num-sponsors {
        font-size: 0.8rem;
        font-weight: 500;
        color: #059669;
        margin-bottom: 2px;
    }

    .your-amount {
        font-size: 0.8rem;
        color: #6b7280;
    }

    .action-section {
        flex-shrink: 0;
    }

    .donate-btn {
        background: #1e3a8a;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .donate-btn:hover {
        background: #1e40af;
        transform: translateY(-1px);
    }

    .donate-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        opacity: 0.6;
    }
    .no-issues {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 400px;
        max-width: 90%;
        position: relative;
    }

    .modal-title {
        color: #111827;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .issue-link {
        color: #6b7280;
        font-size: 0.9rem;
        text-decoration: none;
        margin-bottom: 16px;
    }

    .total-container {
        text-align: center;
        margin-top: 24px;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .total-label {
        font-size: 0.9rem;
        color: #6b7280;
        margin-bottom: 4px;
    }

    .total-amount {
        font-size: 1.75rem;
        font-weight: 700;
        color: #059669;
    }

    .donation-input-group {
        margin: 20px 0;
    }

    .donation-input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #374151;
        font-size: 0.9rem;
    }

    .donation-amount-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 1rem;
        background: white;
        transition: all 0.2s ease;
    }

    .donation-amount-input:focus {
        outline: none;
        border-color: #1e3a8a;
        box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
    }

    .donation-amount-input.error {
        border: 1px solid red;
    }

    .donation-input-group .donation-amount-error {
        color: red;
        margin-top: 4px;
        font-size: 0.875rem;
    }

    .cancel-btn {
        width: 100%;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        margin: 16px 0px 4px 0px;
    }

    .update-btn {
        width: 100%;
        background: #1e3a8a;
        color: white;
    }

    .close {
        color: #999;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 20px;
    }

    .close:hover {
        color: #333;
    }

    @media (max-width: 768px) {
        .issue-item {
            flex-direction: column;
            align-items: stretch;
            gap: 12px;
            padding: 16px 20px;
        }

        .rank-section,
        .donation-section,
        .action-section {
            width: auto;
            text-align: left;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="repo-header">
    <div class="repo-header-content">
        <div class="repo-title-row">
            <h1>{{ owner }}/{{ repo }}</h1>
            <a href="https://github.com/sponsors/{{ owner }}" target="_blank" class="sponsor-btn">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.565 20.565 0 008 13.393a20.561 20.561 0 003.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.75.75 0 01-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5zM8 14.25l-.345.666-.002-.001-.006-.003-.018-.01a7.643 7.643 0 01-.31-.17 22.075 22.075 0 01-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.08 22.08 0 01-3.744 2.584l-.018.01-.006.003h-.002L8 14.25zm0 0l.345.666a.752.752 0 01-.69 0L8 14.25z"></path>
                </svg>
                Sponsor @{{ owner }}
            </a>
        </div>
        {% if not user.is_authenticated %}
        <div class="sponsor-stats">
            <div class="sponsor-stat message">
                <form method="post" action="/accounts/github/login/" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="link-btn">Sign in with GitHub</button>
                </form> to add or remove funds to issues.
            </div>
        </div>
        {% elif total_sponsor_cents == 0 %}
        <div class="sponsor-stats">
            <div class="sponsor-stat message">
                You haven't made any donations to <span class="github_username">@{{ owner }}</span> yet. To add funds to issues, <a href="https://github.com/sponsors/{{ owner }}" target="_blank">send @{{ owner }} a donation on GitHub Sponsors</a>.
            </div>
        </div>
        {% else %}
        <div class="sponsor-stats">
            <div class="sponsor-stat">
                <span>💸</span>
                <span>You've donated to <span class="github_username">@{{owner}}</span>: <span class="dollars-value">{{ total_sponsor_cents|cents_to_dollars }} USD</span></span>
            </div>
            <div class="sponsor-stat">
                <span>💸</span>
                <span>Assigned to issues: <span class="dollars-value">{{ allocated_sponsor_cents|cents_to_dollars }} USD</span></span>
            </div>
            <div class="sponsor-stat">
                <span>💸</span>
                <span>Remaining: <span class="dollars-value">{{ unallocated_sponsor_cents|cents_to_dollars }} USD</span></span>
            </div>
        </div>
        {% endif %}
    </div>
</div>


<div class="issues-list">
    {% if issues %}
        {% for issue in issues %}
        <div class="issue-item">
            <div class="rank-section">
                <div class="rank">#{{ issue.rank }}</div>
            </div>
            <div class="issue-main">
                <div class="issue-title"><a href="https://github.com/{{ owner }}/{{ repo }}/issues/{{ issue.number }}" target="_blank">{{ issue.title }}</a></div>
                <div class="issue-meta">
                    <div class="labels">
                        {% for label in issue.labels %}
                        <span class="label {% if 'bug' in label.name|lower %}label-bug{% elif 'feature' in label.name|lower %}label-feature{% elif 'enhancement' in label.name|lower %}label-enhancement{% elif 'priority' in label.name|lower %}label-priority{% else %}label-default{% endif %}">{{ label.name }}</span>
                        {% endfor %}
                    </div>
                    <div class="issue-number">{{ owner }}/{{ repo }}#{{ issue.number }} {% if issue.state == 'open' %}(open){% else %}(closed){% endif %}</div>
                </div>
            </div>
            <div class="donation-section">
                <div class="donation-amount">{{ issue.donation_total_cents|cents_to_dollars }} USD</div>
                <div class="num-sponsors">{{ issue.num_sponsors }} sponsors</div>
                <div class="your-amount">You: {{ issue.user_donation_cents|cents_to_dollars }} USD</div>
            </div>
            <div class="action-section">
                <button class="donate-btn" onclick="openModal({{ issue }})" {% if not user.is_authenticated or total_sponsor_cents == 0 %}disabled{% endif %}>Add or Remove Funds</button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-issues">
            <h3>No issues found</h3>
            <p>This repository doesn't have any issues yet.</p>
        </div>
    {% endif %}
</div>

<!-- Modal -->
<div id="donateModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title" id="modalTitle"></h3>
        <a class="issue-link" id="modalIssueLink" href="https://github.com/example/awesome-project/issues/42" target="_blank">example/awesome-project#42</a>
        <div class="total-container">
            <div class="total-label">
                New total
            </div>
            <div class="total-amount">
                0.00 USD
            </div>
        </div>
        <form id="donateForm" method="post">
            {% csrf_token %}
            <div class="donation-input-group">
                <label for="donationAmount">Your contribution<span id="oldAmountReminder"></span>:</label>
                <input type="number" id="donationAmount" name="donation_dollars" class="donation-amount-input"
                    value="0" min="0" step="1">
                <label for="donationAmount" id="donationAmountError" class="donation-amount-error"></label>
            </div>
            <button type="button" class="btn cancel-btn" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn update-btn">Update</button>
        </form>
    </div>
</div>

<script>
    let currentIssue = null;

    function openModal(issue) {
        currentIssue = issue;

        const titleElement = document.getElementById('modalTitle');
        titleElement.innerHTML = currentIssue.title;

        const issueLinkElement = document.getElementById('modalIssueLink');
        issueLinkElement.innerHTML = '{{ owner }}/{{ repo }}#' + currentIssue.number;
        issueLinkElement.href = currentIssue.url;

        const donationInput = document.getElementById('donationAmount');
        donationInput.value = cents_to_dollars(currentIssue.user_donation_cents);
        donationInput.max = cents_to_dollars(currentIssue.user_donation_cents + {{ unallocated_sponsor_cents }})

        const donateForm = document.getElementById('donateForm')
        donateForm.action = `/gh/{{ owner }}/{{ repo }}/issue/${currentIssue.number}/donate`;

        document.getElementById('donateModal').style.display = 'block';

        updateTotal();
    }

    function closeModal() {
        document.getElementById('donateModal').style.display = 'none';
    }

    function updateTotal() {
        const donationInput = document.getElementById('donationAmount');

        const totalElement = document.querySelector('.total-amount');
        const donationAmountError = document.getElementById('donationAmountError');

        const donation_cents = dollars_to_cents(donationInput.value);

        // If user types in a number that is greater than their
        // sponsor dollars remaining, show an error message and
        // reset the displayed total.
        var donation_delta = donation_cents - currentIssue.user_donation_cents;
        if (donation_delta > {{ unallocated_sponsor_cents }}) {
            donationInput.classList.add('error')
            donationAmountError.textContent = 'Exceeded sponsor dollars remaining';
            // Show original total and dollars remaining while input
            // box is in error state
            donation_delta = 0;
        } else {
            // Donation amount is okay, so clear any previously displayed error
            donationInput.classList.remove('error')
            donationAmountError.textContent = '';
        }

        // If the user changed their donation amount, or they have entered
        // invalid input into the amount box, remind them what their original
        // donation amount was.
        const oldAmountReminder = document.getElementById('oldAmountReminder');
        if (donation_delta !== 0 || donationInput.classList.contains('error')) {
            const old_amount_dollars = cents_to_dollars(currentIssue.user_donation_cents);
            oldAmountReminder.textContent = ` (was ${old_amount_dollars} USD)`;
        } else {
            oldAmountReminder.textContent = ''
        }

        const new_total_cents = currentIssue.donation_total_cents + donation_delta;
        totalElement.textContent = cents_to_dollars(new_total_cents) + ' USD';

        const dollars_remaining = document.getElementById('dollars_remaining');
        const cents_remaining = {{ unallocated_sponsor_cents }} - donation_delta;
        dollars_remaining.textContent = cents_to_dollars(cents_remaining);
    }

    // Convert a dollars USD value given as a string
    // to an equivalent integer cents value.
    //
    // Return zero if the input string doesn't represent
    // a valid dollar value (e.g. non-numeric characters).
    //
    // The input dollars value may be a whole number
    // (zero decimal places), or may have any number
    // of decimal places following the '.'. In the case that the
    // there are more than two decimal places, use "Banker's Rounding".
    function dollars_to_cents(dollarString) {
        // Remove whitespace and validate input
        const cleaned = String(dollarString).trim();
        if (!cleaned || !/^-?\d*\.?\d*$/.test(cleaned)) {
            return 0;
        }

        // Split on decimal point
        const parts = cleaned.split('.');
        const wholePart = parts[0] || '0';
        const decimalPart = parts[1] || '';

        // Convert whole dollars to cents
        let cents = parseInt(wholePart) * 100;
        if (isNaN(cents)) {
            return 0;
        }

        // Handle decimal part
        if (decimalPart.length === 0) {
            // No decimal part
            return cents;
        } else if (decimalPart.length === 1) {
            // One decimal place
            cents += parseInt(decimalPart) * 10;
        } else if (decimalPart.length === 2) {
            // Two decimal places
            cents += parseInt(decimalPart);
        } else {
            console.log("a")
            // More than two decimal places - use "Banker's Rounding"
            cents += parseInt(decimalPart.substring(0, 2));
            thirdDigit = parseInt(decimalPart.charAt(2))

            if (thirdDigit > 5) {
                cents += 1;
            } else if (thirdDigit === 5) {
                // Check if there any non-zero digits after the 5
                const hasMoreDigits = decimalPart.length > 3 && decimalPart.substring(3).match(/[1-9]/);
                // Note: Checking if `cents` is even/odd
                // is equivalent to checking if the second digit
                // is even/odd.
                if (hasMoreDigits || (cents % 2 === 1)) {
                    cents += 1;
                }
            }
        }

        return cents;
    }

    // Convert an integer value in cents to equivalent
    // dollars value as a string.
    //
    // Note: We use integer division/modulus instead of
    // `parseFloat` here, in order to floating-point precision
    // errors.
    function cents_to_dollars(cents) {
        const dollars = Math.floor(cents / 100);
        const remainingCents = cents % 100;
        return `${dollars}.${remainingCents.toString().padStart(2, '0')}`;
    }

    // Add event listener to donation amount input
    document.addEventListener('DOMContentLoaded', function() {
        const donationInput = document.getElementById('donationAmount');
        donationInput.addEventListener('input', updateTotal);
    });

</script>
{% endblock %}
